# Architecture Document: Cyberpunk Disco Elysium-Style Choose-Your-Own-Adventure Game

## 1. Overview
A web-based, AI-driven narrative adventure game. The experience is split into a left pane (AI-generated map and scene images) and a right pane (AI-powered dialog and “thought cabinet”). Players navigate a 10x10 grid over a single map tile, with all decisions and generated content stored per run. The game has a global world state and autogenerated player identities.

---

## 2. System Components

### 2.1 Frontend (React + TypeScript)
- **UI Layout:**  
  - Left Pane: 1024x1024 map image with 10x10 grid overlay, player marker, point-and-click navigation.
  - Right Pane: Dialog window, thought cabinet (internal monologue), player options.
- **Visual Effects:**  
  - Neon, glitch, pixel art, dark mode.
- **State Management:**  
  - Global world state (fetched from backend).
  - Local player state (identity, position, thought cabinet, decisions).
- **API Integration:**  
  - Fetches images, dialog, and state from backend.
  - Submits player decisions and navigation events to backend.

### 2.2 Backend (Node.js + Express + TypeScript)
- **REST API Endpoints:**
  - `POST /api/map/generate` — Generates and stores a new 1024x1024 map image.
  - `GET /api/map` — Retrieves the current map image and metadata.
  - `POST /api/scene/generate` — Generates and stores a scene image for a given grid cell.
  - `POST /api/dialog` — Generates and returns dialog/thought cabinet content for a given context.
  - `POST /api/player/join` — Registers a new player, assigns autogenerated identity.
  - `POST /api/player/move` — Updates player position, triggers interaction if needed.
  - `POST /api/player/decision` — Records a player’s decision, updates state.
  - `GET /api/state` — Returns current global world and player state.
- **Session Handling:**  
  - Each player has a unique session/identity, but shares the world state.
- **Image and Text Storage:**  
  - Stores all generated images, dialog, and player decisions in SQLite, linked by run and player IDs.

### 2.3 Database (SQLite)
- **Schema:**
  - `world_state` — Stores global map image, seed, and metadata.
  - `players` — Stores player identities, positions, and thought cabinet state.
  - `scenes` — Stores generated scene images and metadata per map cell.
  - `runs` — Stores all narrative text, images, and decisions for each session.
  - `decisions` — Stores player choices and outcomes.

### 2.4 AI Integration
- **Dialog/Thoughts:**  
  - Uses OpenRouter API (configurable server key) to generate narrative and internal monologue.
- **Image Generation:**  
  - Uses a frontier model (e.g., Stable Diffusion, DALL-E) for map and scene images.
- **Prompt Management:**  
  - Prompt templates are stored and refined collaboratively.

---

## 3. Data Flow

1. **Session Start:**  
   - Player joins, receives autogenerated identity, and is assigned a starting position.
   - If world does not exist, backend generates and stores a new map image.
2. **Exploration:**  
   - Player clicks a grid cell to move.
   - Backend updates player position, checks for interactions.
   - If new scene, backend generates and stores scene image and dialog.
   - Frontend displays updated map, scene, dialog, and thought cabinet.
3. **Decision Making:**  
   - Player selects from dialog options.
   - Backend records decision, updates player/world state, and triggers any outcomes (including chance-based results).
4. **Persistence:**  
   - All images, dialog, and decisions are stored in SQLite for analytics, replay, and future features.

---

## 4. Security & Configuration

- **API Keys:**  
  - Server-side storage of OpenRouter and image generation API keys.
- **No authentication** in MVP; all players are anonymous with autogenerated identities.
- **Environment Variables:**  
  - Used for API keys and configuration.

---

## 5. Extensibility & Future Enhancements

- Multi-tile/scrollable world map support.
- Player customization and persistent accounts.
- Analytics dashboard, run sharing, and replay.
- Real-time/multiplayer features.
- Additional AI model integrations.

---

## 6. Deployment

- **Dev:**  
  - Local SQLite, environment variables for keys, nodemon for backend, Vite dev server for frontend.
- **Prod:**  
  - Dockerized services, persistent volume for SQLite, secure environment variable management.

---

## 7. Folder Structure (Proposed)

```
choose_your_own_adventure/
├── backend/
│   ├── src/
│   │   ├── controllers/
│   │   ├── models/
│   │   ├── routes/
│   │   └── utils/
│   ├── database.sqlite
│   └── package.json
├── frontend/
│   ├── src/
│   │   ├── components/
│   │   ├── hooks/
│   │   ├── pages/
│   │   └── styles/
│   └── package.json
├── PROJECT_PLAN.md
└── README.md
```

---

_Last updated: 2025-04-16_
